var SenseSearchInput=function(){function a(a,b){var c=document.createElement("div");c.id=a,c.classList.add("sense-search-input-container");var d=g.replace(/{id}/gim,a);c.innerHTML=d,b=b||{};for(var e in b)this[e]=b[e];this.id=a,c.onkeyup=this.onKeyUp.bind(this),c.onkeydown=this.onKeyDown.bind(this),c.onclick=this.onClick.bind(this);var f=document.getElementById(a);if(f){f.insertAdjacentElement?f.insertAdjacentElement("afterEnd",c):f.insertAdjacentHTML("afterEnd",c.outerHTML);for(var h=0;h<f.attributes.length;h++)this[f.attributes[h].name]=f.attributes[h].value;f.parentNode.removeChild(f)}return this.searchFields&&!Array.isArray(this.searchFields)&&this.searchFields.length&&(this.searchFields=this.searchFields.split(",")),this.suggestFields&&!Array.isArray(this.suggestFields)&&this.suggestFields.length&&(this.suggestFields=this.suggestFields.split(",")),this.searchTimeout=this.searchTimeout||300,this.suggestTimeout=this.suggestTimeout||100,senseSearch.ready.subscribe(this.activate.bind(this)),senseSearch.cleared.subscribe(this.onClear.bind(this)),{element:c,object:this}}function b(a){var b=a.qText;b=b.split("");for(var c=a.qRanges.length-1;c>-1;c--)b.splice(a.qRanges[c].qCharPos+a.qRanges[c].qCharCount,0,"</span>"),b.splice(a.qRanges[c].qCharPos,0,"<span class='highlight"+a.qRanges[c].qTerm+"'>");return b=b.join("")}function c(a,b){var c=a;if(-1!=b.toLowerCase().indexOf(c.toLowerCase()));else if(b.length>c.length)for(;-1==b.toLowerCase().indexOf(c.toLowerCase());)c=c.split(" "),c.splice(0,1),c=c.join(" ");for(;c.length>=b.length&&c.toLowerCase()!=b.toLowerCase();)c=c.split(" "),c.splice(0,1),c=c.join(" ");var d=new RegExp(c,"i");return b.replace(d,"")}var d=[16,27],e=[9,13,38,40,39,37,32,33,34],f={BACKSPACE:8,ESCAPE:27,TAB:9,ENTER:13,SHIFT:16,UP:38,DOWN:40,RIGHT:39,LEFT:37,DELETE:46,SPACE:32},g="<div class='sense-search-input-main'><div id='{id}_ghost' class='sense-search-input-bg'></div><input id='{id}_input' autofocus placeholder='Go ahead, go explore Qlik!' type='text' autocorrect='off' autocomplete='off' autocapitalize='off' spellcheck='false' /><div class='sense-search-lozenge-container'></div><button type='button' class='sense-search-input-clear'>x</button></div><div id='{id}_suggestions' class='sense-search-suggestion-container'><ul id='{id}_suggestionList'></ul></div><div id='{id}_associations' class='sense-search-association-container'><ul id='{id}_associationsList'></ul></div>";return a.prototype=Object.create(Object.prototype,{id:{writable:!0,value:null},attach:{value:function(a){if(a)for(var b in a)this[b]=a[b];senseSearch&&senseSearch.exchange.connection&&(senseSearch.searchAssociations.subscribe(this.onSearchAssociations.bind(this)),senseSearch.suggestResults.subscribe(this.onSuggestResults.bind(this)),senseSearch.inputs[this.id]||(senseSearch.inputs[this.id]=this))}},searchText:{writable:!0,value:null},searchFields:{writable:!0,value:[]},suggestFields:{writable:!0,value:[]},searchTimeout:{writable:!0,value:null},suggestTimeout:{writable:!0,value:null},searchTimeoutFn:{writable:!0,value:null},suggestTimeoutFn:{writable:!0,value:null},suggesting:{writable:!0,value:!1},suggestingTimeout:{writable:!0,value:3e3},suggestingTimeoutFn:{writable:!0,value:null},activeSuggestion:{writable:!0,value:0},ghostPart:{writable:!0,value:null},ghostQuery:{writable:!0,value:null},ghostDisplay:{writable:!0,value:null},cursorPosition:{writable:!0,value:0},mode:{writable:!0,value:"associations"},onClear:{value:function(){document.getElementById(this.id+"_input").value="",this.searchText="",this.hideSuggestions()}},onSearchResults:{value:function(){}},onSearchAssociations:{value:function(a){this.associations=a.qResults,this.showAssociations()}},onSuggestResults:{value:function(a){this.suggestions=a.qSuggestions,this.suggestions.splice(5,a.qSuggestions.length-4),this.suggestions.length>0&&(this.activeSuggestion=0),this.showSuggestions()}},clear:{value:function(){senseSearch.clear()}},onClick:{value:function(a){if(console.log(a),a.target.classList.contains("sense-search-input-clear"))this.clear();else if(a.target.classList.contains("sense-search-suggestion-item"))this.activeSuggestion=parseInt(a.target.attributes["data-index"].value),this.drawGhost(),this.acceptSuggestion();else if(a.target.classList.contains("sense-search-association-item")||a.target.parentNode.classList.contains("sense-search-association-item")){var b;b=a.target.classList.contains("sense-search-association-item")?parseInt(a.target.attributes["data-index"].value):parseInt(a.target.parentNode.attributes["data-index"].value),senseSearch.selectAssociations(this.searchFields||[],b),this.hideAssociations(),this.hideSuggestions()}}},onKeyDown:{value:function(a){if(a.keyCode==f.ESCAPE)return void this.hideSuggestions();if(a.keyCode==f.DOWN)this.showSuggestions();else if(a.keyCode==f.RIGHT)this.suggesting&&(a.preventDefault(),this.nextSuggestion());else if(a.keyCode==f.LEFT)this.suggesting&&(a.preventDefault(),this.prevSuggestion());else if(a.keyCode==f.ENTER||a.keyCode==f.TAB)this.suggesting&&(a.preventDefault(),this.acceptSuggestion());else if(a.keyCode==f.SPACE){if(5==this.searchText.split(" ").length)return alert("Too many search terms"),a.preventDefault(),!1;if(1==this.searchText.split(" ").pop().length)return alert("cannot search for single character strings"),a.preventDefault(),!1;this.hideSuggestions(),this.hideAssociations()}else this.hideSuggestions(),this.hideAssociations()}},onKeyUp:{value:function(a){if(this.searchText=document.getElementById(this.id+"_input").value,this.cursorPosition=a.target.selectionStart,-1==d.indexOf(a.keyCode)&&-1==e.indexOf(a.keyCode))if(this.searchText&&this.searchText.length>0){if(this.searchText.split(" ").pop().length>1){var b=this;this.searchTimeoutFn&&clearTimeout(this.searchTimeoutFn),this.searchTimeoutFn=setTimeout(function(){b.search()},this.searchTimeout),this.searchText.length>1&&this.cursorPosition==this.searchText.length&&(this.suggestTimeoutFn&&clearTimeout(this.suggestTimeoutFn),this.suggestTimeoutFn=setTimeout(function(){b.suggest()},this.suggestTimeout))}}else this.clear()}},showSuggestions:{value:function(){this.startSuggestionTimeout(),this.searchText&&this.searchText.length>1&&this.cursorPosition==this.searchText.length&&this.suggestions.length>0?(this.suggesting=!0,this.drawGhost(),document.getElementById(this.id+"_suggestions").style.display="block",this.drawSuggestions()):(this.suggesting=!1,this.removeGhost(),this.hideSuggestions())}},hideSuggestions:{value:function(){this.suggesting=!1,this.activeSuggestion=0,this.ghostPart="",this.ghostQuery="",this.ghostDisplay="",this.removeGhost(),document.getElementById(this.id+"_suggestions").style.display="none"}},showAssociations:{value:function(){for(var a="",c=0;c<this.associations.qSearchTermsMatched.length;c++)for(var d=this.associations.qSearchTermsMatched[c],e=0;e<d.length;e++){a+="<li class='sense-search-association-item' data-index='"+e+"'>";for(var f=0;f<d[e].qFieldMatches.length;f++){var g=d[e].qFieldMatches.length>1?"small":"",h=d[e].qFieldMatches[f],i=this.associations.qFieldNames[h.qField],j=[];for(var k in h.qValues){var l=b(this.associations.qFieldDictionaries[h.qField].qResult[k],h.qTerms);j.push(l)}a+="<div class='"+g+"'>",a+="<h1>"+i+"</h1>";for(var k=0;k<j.length;k++)a+=j[k],k<j.length-1&&(a+=", ");a+="</div>"}a+="</li>"}document.getElementById(this.id+"_associationsList").innerHTML=a,document.getElementById(this.id+"_associations").style.display="block"}},hideAssociations:{value:function(){document.getElementById(this.id+"_associations").style.display="none"}},startSuggestionTimeout:{value:function(){this.suggestingTimeoutFn&&clearTimeout(this.suggestingTimeoutFn),this.suggestingTimeoutFn=setTimeout(function(){this.hideSuggestions.call(this)}.bind(this),this.suggestingTimeout)}},nextSuggestion:{value:function(){this.startSuggestionTimeout(),this.activeSuggestion==this.suggestions.length-1?this.activeSuggestion=0:this.activeSuggestion++,this.drawGhost(),this.highlightActiveSuggestion()}},prevSuggestion:{value:function(){this.startSuggestionTimeout(),0==this.activeSuggestion?this.activeSuggestion=this.suggestions.length-1:this.activeSuggestion--,this.drawGhost(),this.highlightActiveSuggestion()}},acceptSuggestion:{value:function(){this.searchText=this.ghostQuery,this.suggestions=[],this.hideSuggestions(),document.getElementById(this.id+"_input").value=this.searchText,this.search()}},search:{value:function(){senseSearch.search(this.searchText,this.searchFields||[],this.mode)}},suggest:{value:function(){senseSearch.suggest(this.searchText,this.suggestFields||[])}},drawGhost:{value:function(){this.ghostPart=c(this.searchText,this.suggestions[this.activeSuggestion].qValue),this.ghostQuery=this.searchText+this.ghostPart;var a="<span style='color: transparent;'>"+this.searchText+"</span>"+this.ghostPart;document.getElementById(this.id+"_ghost").innerHTML=a}},removeGhost:{value:function(){document.getElementById(this.id+"_ghost").innerHTML=""}},drawSuggestions:{value:function(){for(var a="",b=0;b<this.suggestions.length;b++)a+="<li id='"+this.id+"_suggestion_"+b+"' class='sense-search-suggestion-item' data-index='"+b+"'>",a+=this.suggestions[b].qValue,a+="</li>";document.getElementById(this.id+"_suggestionList").innerHTML=a,this.highlightActiveSuggestion()}},highlightActiveSuggestion:{value:function(){for(var a=document.getElementById(this.id+"_suggestionList"),b=0;b<a.childElementCount;b++)a.childNodes[b].classList.remove("active");document.getElementById(this.id+"_suggestion_"+this.activeSuggestion).classList.add("active")}},activate:{value:function(){this.attach();var a=document.getElementById(this.id+"_input");a.attributes.placeholder.value="Enter up to 5 search terms",a.disabled=!1}}}),a}(),SenseSearchResult=function(){function a(a,b){var c=document.createElement("div");c.id=a,c.classList.add("sense-search-results-container"),this.resultsElement=a+"_results";var e=d.replace(/{id}/gim,a);c.innerHTML=e,b=b||{};for(var f in b)this[f]=b[f];this.id=a;var g=document.getElementById(a);if(g){g.insertAdjacentElement?g.insertAdjacentElement("afterEnd",c):g.insertAdjacentHTML("afterEnd",c.outerHTML);for(var h=0;h<g.attributes.length;h++)this[g.attributes[h].name]=g.attributes[h].value;g.parentNode.removeChild(g)}return{element:c,object:this}}function b(a,b){for(var c=[],d=0;d<a.length;d++)if(a[d].dimension){var e={qDef:{qFieldDefs:[a[d].dimension]},qNullSuppression:a[d].suppressNull};if(b[a[d].dimension]){var f={};f[b[a[d].dimension].sortType]=b[a[d].dimension].order,b[a[d].dimension].sortExpression&&(f.qExpression=b[a[d].dimension].sortExpression),e.qDef.qSortCriterias=[f]}c.push(e)}return c}function c(a){for(var b=[],c=0;c<a.length;c++)if(a[c].measure){var d={qDef:{qLabel:a[c].label,qDescription:"",qDef:a[c].measure}};a[c].sortType&&(d.qSortBy={},d.qSortBy[a[c].sortType]=a[c].order),b.push(d)}return b}var d="<div id='{id}_results' class='sense-search-results'></div>";return a.prototype=Object.create(Object.prototype,{id:{writable:!0,value:!1},handle:{writable:!0,value:!1},attach:{value:function(a,b){var c=this;if(a)for(var d in a)this[d]=a[d];if(senseSearch&&senseSearch.exchange.connection){var e=this.buildHyperCubeDef();senseSearch.exchange.ask(senseSearch.appHandle,"CreateSessionObject",[e],function(a){c.handle=a.result.qReturn.qHandle,"function"==typeof b&&b.call(null)}),senseSearch.searchResults.subscribe(this.onSearchResults.bind(this)),senseSearch.noResults.subscribe(this.onNoResults.bind(this)),senseSearch.cleared.subscribe(this.onClear.bind(this)),senseSearch.results[this.id]=this}}},fields:{writable:!0,value:[]},data:{writable:!0,value:[]},sortOptions:{writable:!0,value:{}},defaultSort:{writable:!0,value:null},currentSort:{writable:!0,value:null},enableHighlighting:{writable:!0,value:!0},pageTop:{writable:!0,value:0},pageSize:{writable:!0,value:20},buildHyperCubeDef:{value:function(){var a={qInfo:{qType:"table"},qHyperCubeDef:{qDimensions:b(this.fields,this.sortOptions),qMeasures:c(this.fields),qSuppressZero:!1,qSuppressMissing:!1,qInterColumnSortOrder:[this.getFieldIndex(this.defaultSort).index]}};return a}},resultsElement:{writable:!0,value:null},onSearchResults:{value:function(a){this.data=[],this.pageTop=0,this.getHyperCubeData()}},onNoResults:{value:function(){this.renderItems([])}},onClear:{value:function(){document.getElementById(this.id+"_results").innerHTML=""}},getNextBatch:{value:function(){this.pageTop+=this.pageSize,this.getHyperCubeData()}},getHyperCubeData:{value:function(a){var b=this;senseSearch.exchange.getLayout(this.handle,function(c){var d=c.result.qLayout,e=d.qHyperCube.qDimensionInfo.concat(d.qHyperCube.qMeasureInfo);senseSearch.exchange.ask(b.handle,"GetHyperCubeData",["/qHyperCubeDef",[{qTop:b.pageTop,qLeft:0,qHeight:b.pageSize,qWidth:b.fields.length}]],function(c){if(a&&"function"==typeof a)a.call(this,c);else{for(var d=c.result.qDataPages,f=[],g=0;g<d[0].qMatrix.length;g++){var h={};if(!this.nullSuppressor||null==this.nullSuppressor||"-"!=d[0].qMatrix[g][$scope.config.nullSuppressor].qText){for(var i=0;i<d[0].qMatrix[g].length;i++)h[e[i].qFallbackTitle]={value:d[0].qMatrix[g][i].qText,html:b.highlightText(d[0].qMatrix[g][i].qText)};f.push(h)}}b.data=b.data.concat(f),b.renderItems(f)}})})}},getFieldIndex:{value:function(a){for(var b=0;b<this.fields.length;b++){if(this.fields[b].dimension&&this.fields[b].dimension==a)return{index:b,type:"dimension"};if(this.fields[b].label&&this.fields[b].label==a)return{index:b,type:"measure"}}return 0}},highlightText:{value:function(a){if(senseSearch.terms&&this.enableHighlighting){for(var b=senseSearch.terms,c=0;c<b.length;c++)a=a.replace(new RegExp(b[c],"i"),"<span class='highlight"+c+"'>"+b[c]+"</span>");return a}return a}},renderItems:{writable:!0,value:function(a){if(this.data.length>0){var b=document.getElementById(this.id+"_ul");b||(b=document.createElement("ul"),b.id=this.id+"_ul",document.getElementById(this.id+"_results").appendChild(b));var c="",d=0;for(var e in a[0])d++;var f=Math.floor(100/d);c+="<li>";for(var g in a[0])c+="<div class='sense-search-result-cell' style='width: "+f+"%'>",c+="<strong>"+g+"</strong>",c+="</div>";c+="</li>";for(var h=0;h<a.length;h++){c+="<li>";for(var g in a[h])c+="<div class='sense-search-result-cell' style='width: "+f+"%'>",c+=a[h][g].html,c+="</div>";c+="</li>"}document.getElementById(this.id+"_ul").innerHTML=c}else c="<h1>No Results</h1>",document.getElementById(this.resultsElement).innerHTML=c}},applySort:{value:function(a,b,c){var d=this;b=b||!1,c=c||!1,senseSearch.exchange.ask(this.handle,"ApplyPatches",[[{qPath:"/qHyperCubeDef/qInterColumnSortOrder",qOp:"replace",qValue:[d.getFieldIndex(a).index]}],!0],function(){b&&(d.pageTop=0),c&&1==c&&d.getHyperCubeData()})}},invertSort:{value:function(a,b,c){var d,e=this,f=this.getFieldIndex(a);d="dimension"==f.type?"/qHyperCubeDef/qDimensions/"+f.index+"/qDef/qReverseSort":"/qHyperCubeDef/qMeasures/"+f.index+"/qDef/qReverseSort";var e=this;b=b||!1,c=c||!1,senseSearch.exchange.ask(this.handle,"ApplyPatches",[[{qPath:"/qHyperCubeDef/qInterColumnSortOrder",qOp:"replace",qValue:"["+e.getFieldIndex(a).index+"]"},{qPath:d,qOp:"replace",qValue:"true"}],!0],function(){b&&(e.pageTop=0),c&&1==c&&e.getHyperCubeData()})}}}),a}(),SenseSearch=function(){function a(){var a,b,c=0,d=10;this.connect=function(e,f){b=f;try{a=new WebSocket(e)}catch(g){}a.onopen=function(){console.log("Socket connected! readyState = "+a.readyState),c=0,b.call(null,{method:"connected"})},a.onmessage=function(a){var c;c=a.data,b.call(null,JSON.parse(c))},a.onerror=function(a){b.call(null,null)},a.onclose=function(e){d>c?(c++,console.warn("Socket closed! --> Reconnect in 5 secs (retry "+c+")"),setTimeout(function(){3===a.readyState&&b.call(null,{method:"socketClosed",isConnecting:!1})},5e3)):(console.warn("Sorry, can't reconnect socket aftet "+d+" retries"),c=0)}},this.sendMessage=function(c,d){b=d;try{a.send(JSON.stringify(c))}catch(e){throw e}}}function b(){this.callbackList=[]}function c(){this.ready=new b,this.searchResults=new b,this.searchAssociations=new b,this.noResults=new b,this.suggestResults=new b,this.cleared=new b}var d=function(){function b(b,c){if(!b.app)return!1;b=b||{},b.host?b.port=b.port||"":b.port="4848",b.host=b.host||"localhost",b.prefix=b.prefix||"",b.isSecure=b.isSecure||"https:"==window.location.protocol,b.ticket=b.ticket||!1;var d="ws";d+=b.isSecure?"s://":"://",d+=b.host,d+=b.port?":"+b.port:"",d+=b.prefix,d+="/app/",d+=b.app,d+=b.ticket?"qlikTicket="+b.ticket:"",this.connection=new a,this.connection.connect(d,c)}return b.prototype=Object.create(Object.prototype,{connection:{writable:!0,value:null},ask:{value:function(a,b,c,d,e){var f={id:d,handle:a,method:b,params:c};this.connection.sendMessage(f,e)}}}),b}();b.prototype=Object.create(Object.prototype,{subscribe:{value:function(a){this.callbackList.push(a)}},deliver:{value:function(a){for(var b=0;b<this.callbackList.length;b++)this.callbackList[b].call(null,a)}}});var e=function(){function a(a,b,c){var e=this;this.connectionType=b,"Native"==b?this.connection=new d(a,function(){e.connection.ask(-1,"OpenDoc",[a.app],0,function(a){c.call(null,a)})}):"QSocks"==b?(this.connection=a,this.seqId=this.connection.seqid):"CapabilityAPI"==b&&(this.connection=a)}return a.prototype=Object.create(Object.prototype,{connectionType:{writable:!0,value:null},seqId:{writable:!0,value:0},connection:{writable:!0,value:null},ask:{value:function(a,b,c,d){switch(this.connectionType){case"Native":this.askNative(a,b,c,d);break;case"QSocks":this.askQSocks(a,b,c,d);break;case"CapabilityAPI":this.askCapabilityAPI(a,b,c,d)}"Native"==this.connectionType}},askNative:{value:function(a,b,c,d){this.seqId++,this.connection.ask(a,b,c,this.seqId,function(a){a.error||d.call(null,a)})}},askQSocks:{value:function(a,b,c,d){this.seqId++,this.connection.ask(a,b,c,this.seqId).then(function(a){a.error||d.call(null,a)})}},askCapabilityAPI:{value:function(a,b,c,d){var e=this;this.connection.rpc({handle:a,method:b,params:c}).then(function(a){e.seqId=a.id,a.error||d.call(null,a)})}},getLayout:{value:function(a,b){this.ask(a,"GetLayout",[],b)}}}),a}();return c.prototype=Object.create(Object.prototype,{init:{value:function(){for(var a=document.getElementsByTagName("sense-search-input"),b=0;b<a.length;){var c=a[b].id,d=new SenseSearchInput(c);this.inputs[c]=d.object}for(var e=document.getElementsByTagName("sense-search-results"),b=0;b<e.length;){var c=e[b].id,f=new SenseSearchResult(c);this.results[c]=f.object}}},inputs:{writable:!0,value:{}},results:{writable:!0,value:{}},pendingSearch:{writable:!0,value:null},pendingSuggest:{writable:!0,value:null},appHandle:{writable:!0,value:null},exchange:{writable:!0,value:null},connect:{value:function(a,b){var c=this;this.exchange=new e(a,"Native",function(a){a.result&&a.result.qReturn&&(c.appHandle=a.result.qReturn.qHandle,c.ready.subscribe(b),c.ready.deliver())})}},connectWithQSocks:{value:function(a){this.appHandle=a.handle,this.exchange=new e(a.connection,"QSocks"),this.ready.deliver()}},connectWithCapabilityAPI:{value:function(a){this.appHandle=a.global.session.connectedAppHandle,this.exchange=new e(a.global.session,"CapabilityAPI"),this.ready.deliver(),console.log(a)}},readOptions:{value:function(a){for(var b in a)this[0]=a[b]}},ready:{writable:!0,value:null},newResultsDefinition:{value:function(a,b,c){var d=new Result(a);this.results.push(d)}},search:{value:function(a,b,c,d){var e=this;c=c||"simple",d=d||this.context||"LockedFieldsOnly",this.pendingSearch=this.exchange.seqId+1,this.terms=a.split(" "),this.exchange.ask(this.appHandle,"SearchAssociations",[{qContext:d,qSearchFields:b},this.terms,{qOffset:0,qCount:5,qMaxNbrFieldMatches:5}],function(f){f.id==e.pendingSearch&&(""==a||f.result.qResults.qTotalSearchResults>0?"simple"==c?e.selectAssociations(b,0,d):e.searchAssociations.deliver(f.result):e.noResults.deliver())})}},selectAssociations:{value:function(a,b,c){c=c||this.context||"LockedFieldsOnly";var d=this;d.exchange.ask(d.appHandle,"SelectAssociations",[{qContext:c,qSearchFields:a},d.terms,b],function(a){d.searchResults.deliver(a.change)})}},suggest:{value:function(a,b,c){var d=this;d.pendingSuggest=this.exchange.seqId+1,this.exchange.ask(this.appHandle,"SearchSuggest",[{qContext:c||this.context||"LockedFieldsOnly",qSearchFields:b},a.split(" ")],function(a){a.id==d.pendingSuggest&&d.suggestResults.deliver(a.result.qResult)})}},clear:{value:function(){this.terms=null,this.cleared.deliver()}},searchResults:{writable:!0,value:null},searchAssociations:{writable:!0,value:null},noResults:{writable:!0,value:null},suggestResults:{writable:!0,value:null}}),c}(),senseSearch=new SenseSearch;senseSearch.init();